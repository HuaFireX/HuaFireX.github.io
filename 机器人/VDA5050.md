
# VDA5050 协议对接开发指南

> **适用于 RCS4.3 项目快速上手**

---

## 1. 概述

**VDA5050 是 AGV 与主控系统之间的通信协议，基于 MQTT + JSON。**

**协议目标**：实现不同厂商 AGV 的混合调度

**当前 RCS4.3 状态**：使用自定义 TCP 协议，需要改造为 VDA5050

---

## 2. MQTT 主题结构

```
 {interfaceName}/{majorVersion}/{manufacturer}/{serialNumber}/{topic}
 
 例：uagv/v2/YourCompany/AGV001/order
```

### 六大主题

| **主题**     | **方向**        | **说明**     | **必选** |
| ------------------ | --------------------- | ------------------ | -------------- |
| `order`          | **主控 → AGV** | **任务命令** | **✅**   |
| `instantActions` | **主控 → AGV** | **即时动作** | **✅**   |
| `state`          | **AGV → 主控** | **状态上报** | **✅**   |
| `factsheet`      | **AGV → 主控** | **AGV能力**  | **✅**   |
| `connection`     | **AGV → 主控** | **连接状态** | **✅**   |
| `visualization`  | **AGV → 主控** | **可视化**   | **❌**   |

---

## 3. 核心消息格式

### 3.1 factsheet（AGV能力上报）

**发送时机**：AGV 连接时发送，`retain=True`

```
 def publish_factsheet(client):
     factsheet = {
         "manufacturer": "YourCompany",
         "serialNumber": "AGV001",
         "agvClass": "FORKLIFT",          # FORKLIFT / CONVEYOR / TOWTRACTOR
         "maxLoadMass": 1000,
         "maxSpeed": 1.5,
         "maxHeight": 2.5,
         "minHeight": 0.0,
         "weight": 500,
         "width": 1.0,
         "length": 2.0,
         "supportedActions": [              # 支持的动作列表
             "startPause", "stopPause",
             "cancelOrder", "startCharging", "stopCharging",
             "pick", "drop", "initPosition"
         ],
         "protocolFeatures": ["order", "instantActions", "state", "factsheet", "connection"]
     }
     client.publish(f"{BASE_TOPIC}/factsheet", json.dumps(factsheet), retain=True)
```

### 3.2 order（任务命令）

**发送方**：主控 → AGV

```
 {
   "headerId": 1,
   "timestamp": "2024-04-01T10:00:00.00Z",
   "version": "2.0.0",
   "manufacturer": "YourCompany",
   "serialNumber": "AGV001",
   "orderId": "order_001",
   "orderUpdateId": 0,
   "zoneSetId": "",
   "nodes": [
     {
       "nodeId": "node1",
       "sequenceId": 0,
       "released": true,
       "nodePosition": {
         "x": 1.0,
         "y": 2.0,
         "theta": 0.0,
         "allowedDeviationXY": 0.1,
         "allowedDeviationTheta": 0.1,
         "mapId": "map_01"
       },
       "actions": []
     }
   ],
   "edges": [
     {
       "edgeId": "e1",
       "sequenceId": 1,
       "released": true,
       "startNodeId": "node1",
       "endNodeId": "node2",
       "maxSpeed": 1.0,
       "actions": []
     }
   ]
 }
```

**关键字段说明**：

* `orderId`：任务唯一ID
* `orderUpdateId`：任务更新版本（递增）
* `released=true`：已确认路径（base）
* `released=false`：待确认路径（horizon）
* `sequenceId`：节点/边的顺序号（0,1,2...）

### 3.3 instantActions（即时动作）

**发送方**：主控 → AGV

```
 {
   "headerId": 2,
   "timestamp": "2024-04-01T10:05:00.00Z",
   "version": "2.0.0",
   "manufacturer": "YourCompany",
   "serialNumber": "AGV001",
   "actions": [
     {
       "actionType": "startPause",
       "actionId": "action_001"
     }
   ]
 }
```

**常用动作类型**：

| **actionType** | **说明**             |
| -------------------- | -------------------------- |
| `startPause`       | **暂停**             |
| `stopPause`        | **恢复**             |
| `cancelOrder`      | **取消订单**         |
| `stateRequest`     | **请求立即上报状态** |
| `startCharging`    | **开始充电**         |
| `stopCharging`     | **停止充电**         |
| `pick`             | **拾取**             |
| `drop`             | **放置**             |
| `initPosition`     | **初始化位置**       |

### 3.4 state（状态上报）

**发送方**：AGV → 主控（定期或状态变化时）

```
 {
   "timestamp": "2024-04-01T10:10:00.00Z",
   "version": "2.0.0",
   "manufacturer": "YourCompany",
   "serialNumber": "AGV001",
   "orderId": "order_001",
   "orderUpdateId": 0,
   "lastNodeId": "node1",
   "lastNodeSequenceId": 1,
   "nodeStates": [
     {
       "nodeId": "node1",
       "sequenceId": 1,
       "nodeState": "VISITED",
       "timestamp": "2024-04-01T10:10:00.00Z"
     }
   ],
   "edgeStates": [],
   "actionStates": [],
   "position": {
     "x": 1.0,
     "y": 2.0,
     "theta": 0.0,
     "mapId": "map_01"
   },
   "velocity": {
     "x": 0.0,
     "y": 0.0,
     "theta": 0.0
   },
   "batteryState": 95,
   "charging": false,
   "loadState": "EMPTY",
   "paused": false,
   "errors": []
 }
```

**nodeState 状态流转**：

```
 TRAVERSING（行驶中） → VISITED（已到达） → FINISHED（完成）
```

**errors 错误示例**：

```
 "errors": [
   {
     "errorType": "orderCanceled",
     "errorLevel": "WARNING",
     "errorDescription": "Order was canceled by instantAction"
   }
 ]
```

### 3.5 connection（连接状态）

**发送方**：AGV → 主控

```
 {"state": "online"}
 {"state": "offline"}
```

**注意**：通常设置 `retain=True` 和 `will` 遗嘱消息

---

## 4. RCS4.3 对接要点

### 4.1 现有代码位置

| **功能**     | **文件位置**                                   |
| ------------------ | ---------------------------------------------------- |
| **状态上报** | `layer4_task/scheduler_task/SendPackage.py`        |
| **任务接收** | `layer4_task/scheduler_task/SchedulerInterface.py` |
| **AGV数据**  | `structure/AGV_Data.py`                            |
| **通信层**   | `layer1_communication/`                            |

### 4.2 改造思路

1. **新增 MQTT 客户端模块**（建议放在 `layer1_communication/`）
2. **消息映射对照**

| **现有 RCS 消息** | **VDA5050 主题**                    |
| ----------------------- | ----------------------------------------- |
| **REGISTER**      | **factsheet**                       |
| **STATE**         | **state**                           |
| **ARRIVE**        | **state.nodeStates**                |
| **FINISH**        | **state.nodeStates + actionStates** |
| **ACK**           | **无（MQTT自动确认）**              |

3. **关键数据转换**

```
# RCS → VDA5050 state
vda_state = {
    "timestamp": timestamp,
    "orderId": current_order_id,
    "lastNodeId": current_node_id,
    "position": {
        "x": agv_x,
        "y": agv_y,
        "theta": agv_phi
    },
    "batteryState": bms_soc,
    "loadState": "EMPTY" if not loaded else "LOADED",
    "paused": is_paused,
    "velocity": {"x": speed, "y": 0, "theta": 0}
}
```

### 4.3 order 解析示例

```
def handle_order(order_data):
    order_id = order_data["orderId"]
    nodes = order_data["nodes"]
    edges = order_data["edges"]

    # 提取已释放的路径（base）
    base_nodes = [n for n in nodes if n.get("released", False)]
    base_edges = [e for e in edges if e.get("released", False)]

    # 转换为RCS内部任务格式
    path_points = []
    for node in base_nodes:
        pos = node.get("nodePosition", {})
        path_points.append((pos["x"], pos["y"], pos.get("theta", 0)))

    # 下发执行
    execute_path(path_points)
```

---

## 5. 测试命令速查

### 5.1 订阅 AGV 上报

```
# 订阅所有主题
mosquitto_sub -t "uagv/v2/YourCompany/AGV001/#" -v

# 单独订阅
mosquitto_sub -t "uagv/v2/YourCompany/AGV001/state" -v
mosquitto_sub -t "uagv/v2/YourCompany/AGV001/factsheet" -v
```

### 5.2 发送命令测试

```
# 发送 order
mosquitto_pub -t "uagv/v2/YourCompany/AGV001/order" -m '{
  "headerId": 1,
  "timestamp": "2024-04-01T10:00:00.00Z",
  "version": "2.0.0",
  "manufacturer": "YourCompany",
  "serialNumber": "AGV001",
  "orderId": "test_001",
  "orderUpdateId": 0,
  "nodes": [
    {"nodeId": "node1", "sequenceId": 0, "released": true,
     "nodePosition": {"x": 1.0, "y": 2.0, "theta": 0.0}},
    {"nodeId": "node2", "sequenceId": 2, "released": true,
     "nodePosition": {"x": 5.0, "y": 2.0, "theta": 0.0}}
  ],
  "edges": [
    {"edgeId": "e1", "sequenceId": 1, "released": true,
     "startNodeId": "node1", "endNodeId": "node2"}
  ]
}'

# 发送即时动作 - 暂停
mosquitto_pub -t "uagv/v2/YourCompany/AGV001/instantActions" -m '{
  "headerId": 2,
  "timestamp": "2024-04-01T10:05:00.00Z",
  "version": "2.0.0",
  "manufacturer": "YourCompany",
  "serialNumber": "AGV001",
  "actions": [{"actionType": "startPause", "actionId": "action_001"}]
}'

# 发送即时动作 - 取消订单
mosquitto_pub -t "uagv/v2/YourCompany/AGV001/instantActions" -m '{
  "headerId": 3,
  "timestamp": "2024-04-01T10:06:00.00Z",
  "version": "2.0.0",
  "manufacturer": "YourCompany",
  "serialNumber": "AGV001",
  "actions": [{"actionType": "cancelOrder", "actionId": "action_002"}]
}'

# 请求状态上报
mosquitto_pub -t "uagv/v2/YourCompany/AGV001/instantActions" -m '{
  "headerId": 4,
  "timestamp": "2024-04-01T10:07:00.00Z",
  "version": "2.0.0",
  "manufacturer": "YourCompany",
  "serialNumber": "AGV001",
  "actions": [{"actionType": "stateRequest", "actionId": "action_003"}]
}'
```

---

## 6. 参考代码

**完整 demo 示例：**`vda5050_test/vda5050_agv_demo.py`

**核心流程：**

1. **连接 MQTT broker**
2. **发布 factsheet（retain=True）**
3. **发布 connection: online**
4. **订阅 order 和 instantActions**
5. **收到 order → 解析执行 → 上报 state**
6. **收到 instantActions → 响应 → 上报 state**
7. **定期上报 state（或状态变化时）**

---

## 7. 附录：错误码参考

| **errorType**  | **说明**                   |
| -------------------- | -------------------------------- |
| `orderCanceled`    | **订单被取消**             |
| `validationError`  | **订单格式错误**           |
| `orderError`       | **订单包含无法执行的操作** |
| `orderUpdateError` | **orderUpdateId 错误**     |
| `batteryLow`       | **电量低**                 |
| `obstacleDetected` | **检测到障碍物**           |
| `localizationLost` | **定位丢失**               |

---

**更新于：2026-02-28**
